<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ejercicio2</title>
    <style>
        #contenedor {
            display: flex;
            flex-direction: row;
            justify-content: space-evenly;
        }

        #form {
            border: 1px solid black;
            padding: 20px;
            border-radius: 10px;
        }
    </style>
</head>

<body>
    <div id="contenedor">
        <div id="form">
            <form action="">
                <h1>PRODUCTOS</h1>
                <label for="nombre">Nombre:</label>
                <select name="nombre" id="nombre">
                    <option value=""></option>
                </select><br><br>

                <label for="precio">Precio:</label>
                <br>
                <label for="precio">Min: </label><input type="number" step="0.01" min="0.01" name="precioMin"
                    id="precio1"></br>
                <label for="precio">Max: </label><input type="number" step="0.01" min="precioMin" name="precioMax"
                    id="precio2"></br>

                <br>
                <label for="categorias">Categoria:</label>
                <select name="categorias" id="categorias">
                    <option value=""></option>
                </select><br><br>

                <input type="button" id="getProducts" value="Filtrar" onclick="filtrarProductos()">
            </form>
        </div>
        <div id="form">
            <form>
                <h1>CATEGORÍAS</h1>
                <label for="nombre">Nombre:</label>
                <select name="nombre" id="nombreCategoria">
                    <option value=""></option>
                </select><br><br>

                <label for="descripcion">Descripcion:</label>
                <input type="text" name="descripcion" id="descripcionCategoria" pattern="[a-zA-Z]+" required></br><br>

                <input type="button" id="getCategories" value="Filtrar" onclick="filtrarCategorias()">
            </form>
        </div>

        <div class="tablaProductos">
            <table id="table">
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        <p id="msg"></p>
    </div>
    <script>
        let nombre = document.getElementById('nombre');
        let precioMin = document.getElementById('precio1');
        let precioMax = document.getElementById('precio2');
        let categoryId = document.getElementById('categorias');

        let nombreCategoria = document.getElementById('nombreCategoria');
        let descripcionCategoria = document.getElementById('descripcionCategoria');

        let tabla = document.getElementById('table');
        let boton = document.getElementById('getProducts');
        let boton2 = document.getElementById('getCategorias');
        const SERVER = 'http://localhost:3000'

        new Promise(function (resolve, reject) {
            let peticion = new XMLHttpRequest()
            peticion.open('GET', SERVER + '/categories');
            peticion.send()

            peticion.addEventListener('load', () => {
                if (peticion.status === 200) {
                    const data = JSON.parse(peticion.response)
                    const getCategoriaProductos = document.getElementById('categorias');
                    const getNombreCategoria = document.getElementById('nombreCategoria');
                    let opt;
                    let opt2;

                    for (i = 0; i < data.length; i++) {
                        opt = document.createElement("option");
                        opt.innerHTML = data[i]['name'].toUpperCase();
                        opt.value = data[i]['id'];
                        opt2 = document.createElement("option");
                        opt2.innerHTML = data[i]['name'].toUpperCase();
                        opt2.value = data[i]['name'];
                        getCategoriaProductos.appendChild(opt);
                        getNombreCategoria.appendChild(opt2);
                    }
                } else {
                    reject("Error " + this.status + " (" + this.statusText + ") en lapetición")
                }
            })
            peticion.addEventListener('error', () => reject('Error en la petición HTTP'))
        })


        new Promise(function (resolve, reject) {
            let peticion = new XMLHttpRequest()
            peticion.open('GET', SERVER + '/products');
            peticion.send()

            peticion.addEventListener('load', () => {
                if (peticion.status === 200) {
                    const data = JSON.parse(peticion.response)
                    const getNombres = document.getElementById('nombre');

                    for (i = 0; i < data.length; i++) {
                        opt = document.createElement("option");
                        opt.innerHTML = data[i]['name'].toUpperCase();
                        opt.value = data[i]['name'];
                        opt.className = 'options';
                        getNombres.appendChild(opt);
                    }

                } else {
                    reject("Error " + this.status + " (" + this.statusText + ") en lapetición")
                }
            })
            peticion.addEventListener('error', () => reject('Error en la petición HTTP'))
        })


        function filtrarProductos() {
            return new Promise(function (resolve, reject) {
                let peticion = new XMLHttpRequest();
                let url = ''
                if (nombre.value != '') {
                    url += 'name=' + nombre.value + '&';
                }
                if (precioMin.value != '') {
                    url += 'price_gte=' + precioMin.value + '&';
                }
                if (precioMax.value != '') {
                    url += 'price_lte=' + precioMax.value + '&';
                }
                if (categoryId.value != '') {
                    url += 'categoryId=' + categoryId.value + '&';
                }

                peticion.open('GET', SERVER + '/products?' + url);
                peticion.send();
                console.log(peticion);
                peticion.addEventListener('load', () => {
                    if (peticion.status === 200) {
                        const data = JSON.parse(peticion.responseText);

                        tabla.innerHTML = '';
                        var thead = document.createElement("thead");
                        var tr = document.createElement("tr");

                        var headers = ["ID", "Nombre", "Precio", "Descripcion"];
                        headers.forEach(function (header) {
                            var th = document.createElement("th");
                            th.textContent = header;
                            tr.appendChild(th);
                        });

                        thead.appendChild(tr);
                        tabla.appendChild(thead);

                        var tableBody = document.createElement("tbody");
                        data.forEach(function (item) {
                            console.log(item);
                            var row = tableBody.insertRow();
                            row.insertCell(0).innerHTML = item['id'];
                            row.insertCell(1).innerHTML = item['name'];
                            row.insertCell(2).innerHTML = item['price'];
                            row.insertCell(3).innerHTML = item['description'];
                        })
                        tabla.appendChild(tableBody);
                        if (tableBody.innerHTML == '') {
                            document.getElementById('msg').innerHTML = 'Ningun resultado para los filtros seleccionados';
                        }
                    }
                    else {
                        reject("Error " + peticion.status + " (" + peticion.statusText + ") en la petición");
                    }
                })
                peticion.addEventListener('error', () => reject('Error en la petición HTTP'));
            })
        }

        /*
        function filtrarCategorias() {
            return new Promise(function (resolve, reject) {
                let peticion = new XMLHttpRequest();
                let url = ''
                if (nombreCategoria.value != '') {
                    url += 'name=' + nombreCategoria.value + '&';
                }
                if (descripcionCategoria.value != '') {
                    url += 'descripcion=' + descripcionCategoria.value + '&';
                }

                peticion.open('GET', SERVER + '/categories?' + url);
                peticion.send();
                console.log(peticion);
                peticion.addEventListener('load', () => {
                    if (peticion.status === 200) {
                        const data = JSON.parse(peticion.responseText);

                        data.forEach(function (item) {
                            console.log(item);
                            var row = tableBody.insertRow();
                            row.insertCell(0).innerHTML = item['id'];
                            row.insertCell(1).innerHTML = item['name'];
                            row.insertCell(2).innerHTML = item['price'];
                            row.insertCell(3).innerHTML = item['description'];
                        })
                        if (tableBody.innerHTML == '') {
                            document.getElementById('msg').innerHTML = 'Ningun resultado para los filtros seleccionados';
                        }
                    }
                    else {
                        reject("Error " + peticion.status + " (" + peticion.statusText + ") en la petición");
                    }
                })
                peticion.addEventListener('error', () => reject('Error en la petición HTTP'));
            })
        }
        */
    </script>
</body>

</html>